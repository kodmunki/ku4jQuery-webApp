(function(j){j.ku4webApp={config:{templates:{}},templates:{},models:{},controllers:{},views:{}};function d(A){d.base.call(this);j.list(A).each(this._add,this)}d.prototype={_add:function(A){var B=j[A.type](A.selector);if(j.exists(A.spec)){B.spec(A.spec)}if(j.exists(A.maxDims)){B.maxDims(A.maxDims)}if((A.required===true)&&j.isFunction(B.required)){B.required()}if(j.exists(A.format)&&j.isFunction(B.format)){B.format(A.format)}if(j.isNullOrEmpty(B.dom().name)){throw j.ku4exception("form","Form requires all field DOM elements have a valid 'name' attribute")}else{this.add(B.dom().name,B)}}};j.Class.extend(d,j.form.Class);j.ku4webApp.form=function(A){return new d(A)};function h(A){this._container=j(A);this._display="css-responsebox-show"}h.prototype={show:function(A){this._container.html(A).addClass(this._display)},hide:function(){this._container.html("").removeClass(this._display)}};j.ku4webApp.responsebox=function(A){return new h(A)};function l(A){this._config=A}l.prototype={validate:function(C){var A=this._config,E=true,B=j.hash({}),D=C||j.dto();j.list(A).each(function(I){var G=I.name,F=I.spec,H=I.message,J=D.find(G);if(F.isSatisfiedBy(J)){return}E=false;B.add(G,H)});return{isValid:function(){return E},messages:function(){return B.toObject()}}}};j.ku4webApp.validator=function(A){return new l(A)};function c(D,C,B,A){this._modelFactory=y("controllers","modelFactory",D);this._formFactory=y("controllers","formFactory",C);this._navigator=B;this._stateMachine=A}c.prototype={$model:function(A){return this._modelFactory.create(A)},$form:function(A){return this._formFactory.create(A)},$navigator:function(){return this._navigator},$stateMachine:function(){return this._stateMachine}};j.ku4webApp.controller=function(B,C){function A(G,F,E,D){A.base.call(this,G,F,E,D)}A.prototype=C;j.Class.extend(A,c);j.ku4webApp.controllers[B]=function(F){var D=j.str.format("$.ku4webApp.controllers.{0}",B),E=j.str.format("Requires a valid app. app= {0}",F);if(!j.exists(F)){throw j.ku4exception(D,E)}return new A(F.modelFactory,F.formFactory,F.navigator,F.stateMachine)}};function t(E,A,B,F,C,D){this._mediator=y("models","mediator",E);this._serviceFactory=y("models","serviceFactory",A);this._socketFactory=y("models","socketFactory",B);this._storeFactory=y("models","storeFactory",F);this._validatorFactory=y("models","validatorFactory",C);this._appState=D;this._state=j.ku4webApp.state()}t.prototype={$mediator:function(){return this._mediator},$collection:function(A){return this._storeFactory.create(A)},$service:function(A){return this._serviceFactory.create(A)},$socket:function(A){return this._socketFactory.create(A)},$validator:function(A){return this._validatorFactory.create(A)},$state:function(){return this._state},$appState:function(A){if(!j.exists(A)){return this._appState}this._appState.set(A);return this},$notify:function(){var A=this._mediator;A.notify.apply(A,arguments);return this}};function p(A){this._modelFactory=y("stateMachine","modelFactory",A);this._state=j.ku4webApp.state();this._securityLock=j.lock()}p.prototype={$model:function(A){return this._modelFactory.create(A)},is:function(A){return this._state.is(A)},set:function(A){this._state.set(A);return this},read:function(A){return this._state.read(A)},write:function(A,B){this._state.write(A,B);return this},lock:function(){this._securityLock.lock();return this},unlock:function(){this._securityLock.unlock();return this},isLocked:function(){return this._securityLock.isLocked()},isUnlocked:function(){return !this.isLocked()},value:function(){return this._state.value()}};j.ku4webApp.model=function(B,C,D){function A(I,E,F,J,G,H){A.base.call(this,I,E,F,J,G,H)}A.prototype=C;j.Class.extend(A,t);j.ku4webApp.models[B]=function(I,E,F,J,G,H){var K=new A(I,E,F,J,G,H);if(j.exists(D)){j.hash(D).each(function(O){var L=O.key,M=O.value,Q=j.str.format("ku4webApp.model.{0}_{1}",B,M),P=K[M];try{I.unsubscribe(L,Q).subscribe(L,P,K,Q)}catch(N){throw j.ku4exception("$.ku4webApp.model",j.str.format("$.ku4webApp.model.{0} cannot subscribe to mediator with name: {1} or method: {2}.\n\nmessage:{3}\n\n",B,L,M,N.message))}})}return K}};function z(D,C,B){this._mediator=D;this._config=B;var A=j.service(C)[B.verb]().uri(B.uri);A.contentType(B.contentType);if(j.exists(B.success)){A.onSuccess(function(E){D.notify(B.success,E,A.processId())},this,B.success)}if(j.exists(B.error)){A.onError(function(E){D.notify(B.error,E,A.processId())},this,B.success)}if(j.exists(B.complete)){A.onComplete(function(E){D.notify(B.complete,E,A.processId())},this,B.complete)}if(j.exists(B.abort)){A.onAbort(function(E){D.notify(B.abort,E,A.processId())},this,B.abort)}if(j.exists(B.timeout)){A.onTimeout(function(E){D.notify(B.timeout,E,A.processId())},this,B.abort)}if(j.exists(B.timeoutms)){A.timeout(B.timeoutms)}this._service=A}z.prototype={cache:function(){this._service.cache();return this},noCache:function(){this._service.noCache();return this},lock:function(){this._service.lock();return this},unlock:function(){this._service.unlock();return this},abort:function(){this._service.abort();return this},call:function(A){this._service.call(A);return this}};j.ku4webApp.service=function(C,B,A){return new z(C,B,A)};var w,n;function s(){if(j.isUndefined(w)){w=(j.exists(n))?n():null}return w}function q(C,B){if(!j.exists(B.event)){throw new Error("Invalid socket event configuration")}this._event=B.event;var A=s();if(!j.exists(A)){throw new Error("Missing socket.io dependency. Add socket.io to your application.")}if(j.exists(B.success)){A.on(this._event,function(D){C.notify(B.success,D)})}if(j.exists(B.error)){A.on("error",function(D){C.notify(B.error,D)})}}q.prototype={call:function(A){s().emit(this._event,A)}};j.ku4webApp.socket=function(B,A){return new q(B,A)};function k(A){this._value=A;this._data=j.hash()}k.prototype={is:function(A){return this._value===A},set:function(A){this._value=A;return this},read:function(A){return this._data.findValue(A)},write:function(A,B){this._data.update(A,B);return this},value:function(){return this._value}};j.ku4webApp.state=function(A){return new k(A)};j.ku4webApp.stateMachine=function(B,C){function A(D){A.base.call(this,D)}A.prototype=B;j.Class.extend(A,p);j.ku4webApp.$stateMachine=function(E,F){var D=new A(F);if(j.exists(C)){j.hash(C).each(function(J){var G=J.key,H=J.value,L=j.str.format("ku4webApp.stateMachine.{0}",H),K=D[H];try{E.unsubscribe(G,L).subscribe(G,K,D,L)}catch(I){throw j.ku4exception("$.ku4webApp.stateMachine",j.str.format("$.ku4webApp.stateMachine cannot subscribe to mediator with name: {0} or method: {1}.\n\nmessage:{2}\n\n",G,H,I.message))}})}return D}};function m(C,A,B,D){this._mediator=C;this._config=A;this._key=B;this._collection=D}m.prototype={init:function(C,E,B){var A=E||function(){},D=B||this;this.__collection(function(F,G){if(j.exists(F)){A.call(D,F,null)}else{G.init(C).save(function(H){A.call(D,H,this)},this)}},this);return this},find:function(F,E,C){var B=this.__config(),A=E||function(){},D=C||this;this.__collection(function(H,I){if(j.exists(H)){A.call(D,H,null)}else{var G=I.find(F);A.call(D,null,G);if(j.exists(B.find)){this._mediator.notify(B.find,data)}}},this)},insert:function(E,G,C){var B=this.__config(),D=j.str.format('Cannot insert invalid type: {1} into Collection["{0}"]',B.name,E),A=G||function(){},F=C||this;this.__collection(function(H,I){if(j.exists(H)){A.call(F,H,null)}else{if(!j.exists(E)){throw j.ku4exception("Collection",D)}else{I.insert(E).save(function(J){A.call(F,J,this);if(j.exists(B.insert)){this._mediator.notify(B.insert,I)}},this)}}},this);return this},insertList:function(D,F,C){var B=this.__config(),A=F||function(){},E=C||this;this.__collection(function(G,H){if(j.exists(G)){A.call(E,G,null)}else{H.insertList(D).save(function(I){A.call(E,I,this);if(j.exists(B.insert)){this._mediator.notify(B.insert,H)}},this)}},this);return this},update:function(E,C,F,H){var A=this.__config(),G=j.str.format('Cannot update type: {1} into Collection["{0}"]',A.name,C),I=F||function(){},D=H||this;if(!j.exists(C)){throw j.ku4exception("Collection",G)}var B=(j.exists(C.toObject))?C.toObject():C;this.__collection(function(J,K){if(j.exists(J)){I.call(D,J,null)}else{K.update(E,B).save(function(L){I.call(D,L,this);if(j.exists(A.update)){this._mediator.notify(A.update,K)}},this)}},this);return this},remove:function(E,I,J){var H=j.isFunction(E),G=(H)?null:E,K=(H)?E:I,A=(H)?I:J,D=(j.exists(G)&&j.exists(G.toObject))?G.toObject():G,C=this.__config(),B=K||function(){},F=A||this;this.__collection(function(L,M){if(j.exists(L)){B.call(F,L,null)}else{M.remove(D).save(function(N){B.call(F,N,this);if(j.exists(C.remove)){this._mediator.notify(C.remove,M)}},this)}},this);return this},join:function(){var D=this._config,A=arguments[0],L=arguments[1],K=arguments[2],J=arguments[3],H=arguments[4],F=arguments[5],G=arguments.length==3,I=arguments.length==4,O=arguments.length==5,M=D[A],E=(j.exists(M))?M.name:A,P=(G)?K:(I)?J:H,B=(G)?J:(I)?H:F,C=P||function(){},N=B||this;this.__collection(function(R,Q){this.__store().read(E,function(V,U){var W=(function(){if(G){return Q.join(U,L)}if(I){return Q.join(U,L,K)}if(O){return Q.join(U,L,K,J)}return null})();if(!j.exists(W)){C.call(N,j.ku4exception("$.ku4webApp.store","Join exception"))}else{var X=W.name(),S=j.hash(D).replicate().add(X,{name:X}).toObject(),T=new m(this._mediator,S,X,W);C.call(N,V,T)}},this)},this)},exec:function(C,E,B){var A=E||function(){},D=B||this;this.__collection(function(G,H){if(j.exists(G)){A.call(D,G,null)}else{var F=new m(this._mediator,this._config,this._key,H.exec(C));A.call(D,G,F)}},this);return this},__config:function(){return y("Collection","config",this._config[this._key])},__store:function(){var A=this._config.ku4StoreType;switch(A){case"memory":return j.ku4memoryStore();case"indexedDB":return j.ku4indexedDbStore();default:return j.ku4localStorageStore()}},__collection:function(D,A){var B=this._collection,C=A||this;if(j.exists(B)){D.call(C,null,B)}else{this.__store().read(this.__config().name,D,C)}}};j.ku4webApp.store=function(C,A,B,D){return new m(C,A,B,D)};function e(E,C,A){this._modelFactory=E;this._stateMachine=A;this._config=C;this._routes=(j.exists(C))?j.hash(C.ku4routes):j.hash();this._catchAll=this._routes.find("ku4default");this._exceptionRule=0;this._mute=false;var D=this;function B(F){j.evt.mute(F);if(!D._mute){D.execute(D.read())}D._mute=false}if(j.exists(window.addEventListener)){window.addEventListener("hashchange",B)}else{if(j.exists(window.attachEvent)){window.attachEvent("onhashchange",B)}}}e.prototype={throwErrors:function(){this._exceptionRule=2;return this},logErrors:function(){this._exceptionRule=1;return this},catchErrors:function(){this._exceptionRule=0;return this},hashEquals:function(A){return this.read()==A},hashContainsArguments:function(){return/_ku4_/.test(this.read())},hash:function(A){return(j.exists(A))?this.write(A):this.read().split("_ku4_")[0]},read:function(){return location.hash.substr(1)},write:function(){var A=Array.prototype.slice.call(arguments),C=A.shift(),B=(A.length>0)?this._encodeArgs(A):"",D=(j.isNullOrEmpty(B))?C:j.str.build(C,"_ku4_",B);if(this.read()==D){return this}this._mute=true;location.hash=D;return this},execute:function(){this.write.apply(this,arguments);this._execute(this.read());return this},executeOrDefault:function(D,C){var A=this._config;if(!j.exists(A)||!j.isString(D)){return}var B=D.split("_ku4_")[0];return(j.exists(A[B]))?this._execute(D):this._execute(C)},route:function(){var C=this.hashContainsArguments(),D=(C)?this.hash()+"*":this.hash(),A=this._routes.findValue(D),E=(C)?"_ku4_"+this._readArgs():"",B=(j.exists(A))?A+E:"";this.executeOrDefault(B,this._routes.findValue("ku4default"))},tryRouteOrHash:function(B){try{this.route()}catch(A){this.execute(B)}},forward:function(A){if(j.exists(A)){this._setCallback(A)}window.history.forward();return this},back:function(A){if(j.exists(A)){this._setCallback(A)}window.history.back();return this},clear:function(){return this.hash("")},_execute:function(L){var A=this._config;if(!j.exists(A)){return this}var J=L.split("_ku4_"),M=J[0],H=(J.length>1)?this._decodeArgs(J[1]):[],D=A[M];if(!j.exists(D)){return this}var C=D.stateMachine,G=j.exists(C)?"stateMachine":D.model,K=D.method,E=(j.exists(C))?this._stateMachine:this._modelFactory.create(G);if((j.exists(C)||j.exists(G))&&j.exists(K)){try{E[K].apply(E,H)}catch(F){try{var I=A[this._catchAll],B=(j.exists(C))?this._stateMachine:this._modelFactory.create(I.model);B[I.method]()}catch(F){this._alertException(F,G,K)}}}return this},_readArgs:function(){return this.read().split("_ku4_")[1]},_encodeArgs:function(A){if(j.isNullOrEmpty(A)){return""}return j.str.encodeBase64(j.json.serialize(A))},_decodeArgs:function(A){if(j.isNullOrEmpty(A)){return""}return j.json.deserialize(j.str.decodeBase64(A))},_setCallback:function(A){setTimeout(function(){A()},800)},_alertException:function(E,A,B){var D=this._exceptionRule,C=j.ku4exception("$.ku4webApp.navigator",j.str.format("{0}. Model: {1}, Method: {2}",E.message,A,B));if(D==2){throw C}if(D==1){j.ku4Log(C.message)}}};j.ku4webApp.navigator=function(C,B,A){return new e(C,B,A)};function v(A){this._config=y("templates","config",A)}v.prototype={$config:function(A){return(j.exists(A))?this._config[A]:this._config},$forms:function(A){return(j.exists(A))?this._config.forms[A]:this._config.forms},$views:function(A){return(j.exists(A))?this._config.views[A]:this._config.views},$render:function(B,C,E,D){var A=D||function(F){return F};return j.str.render(B,A(C),E)},$renderList:function(D,C,F,E){var A="",G=(!j.isFunction(F))?F:null,B=(j.isFunction(F))?F:(j.isFunction(E))?E:function(H){return H};j.list(C).each(function(H){A+=this.$render(D,B(H),G)},this);return A},$renderListWithAction:function(C,D,E){var A="",B=E||function(F){return F};j.list(C).each(function(F){A+=D.call(this,B(F))},this);return A}};j.ku4webApp.abstractTemplate=v;j.ku4webApp.template=function(A,C){function B(D){B.base.call(this,D)}B.prototype=C;j.Class.extend(B,v);j.ku4webApp.templates[A]=function(D){var E=y(j.str.format("templates.{0}",A),"config",D);return new B(E)}};function a(C,B,A){this._templateFactory=y("views","templateFactory",C);this._formFactory=y("views","formFactory",B);this._navigator=y("views","navigator",A);this._state=j.ku4webApp.state()}a.prototype={$template:function(A){return this._templateFactory.create(A)},$form:function(A){return this._formFactory.create(A)},$navigator:function(){return this._navigator},$state:function(){return this._state}};j.ku4webApp.abstractView=a;j.ku4webApp.__views={};j.ku4webApp.view=function(B,C,D){function A(G,F,E){A.base.call(this,G,F,E)}A.prototype=C;j.Class.extend(A,a);j.ku4webApp.views[B]=function(G){var E=j.str.format("$.ku4webApp.views.{0}",B),F=j.str.format("Requires a valid app. app= {0}",G);if(!j.exists(G)){throw j.ku4exception(E,F)}if(!j.exists(j.ku4webApp.__views[B])){var H=new A(G.templateFactory,G.formFactory,G.navigator);if(j.exists(D)){j.hash(D).each(function(L){var I=L.key,J=L.value,N=j.str.format("ku4webApp.view_{0}_{1}",B,J),M=H[J];try{G.mediator.unsubscribe(I,N).subscribe(I,M,H,N)}catch(K){throw j.ku4exception("$.ku4webApp.view",j.str.format("$.ku4webApp.view.{0} cannot subscribe to mediator with name: {1} or key: {2}.\n\nmessage:{3}\n\n",B,I,J,K.message))}})}j.ku4webApp.__views[B]=H}return j.ku4webApp.__views[B]}};function f(A){this._config=A}f.prototype={create:function(A){return j.ku4webApp.form(this._config[A])}};j.ku4webApp.formFactory=function(A){return new f(A)};function i(E,A,B,F,C,D){var G=j.hash();j.hash(j.ku4webApp.models).each(function(H){G.add(H.key,H.value(E,A,B,F,C,D))},this);this._models=G}i.prototype={create:function(A){return this._models.find(A)}};j.ku4webApp.modelFactory=function(E,A,B,F,C,D){return new i(E,A,B,F,C,D)};function b(C,A){var B=j.hash();j.hash(A).each(function(D){B.add(D.key,j.ku4webApp.service(C,D.key,D.value))},this);this._services=B}b.prototype={create:function(A){return this._services.find(A)}};j.ku4webApp.serviceFactory=function(B,A){return new b(B,A)};function u(C,A){var B=j.hash();j.hash(A).each(function(D){B.add(D.key,j.ku4webApp.socket(C,D.value))},this);this._sockets=B}u.prototype={create:function(A){return this._sockets.find(A)}};j.ku4webApp.socketFactory=function(B,A){return new u(B,A)};function x(B,A){this._mediator=B;this._config=A}x.prototype={create:function(A){return j.ku4webApp.store(this._mediator,this._config,A)}};j.ku4webApp.storeFactory=function(B,A){return new x(B,A)};function r(A){this._config=A}r.prototype={create:function(A){return j.ku4webApp.templates[A](this._config)}};j.ku4webApp.templateFactory=function(A){return new r(A)};function g(A){this._config=A}g.prototype={create:function(A){return j.ku4webApp.validator(this._config[A])}};j.ku4webApp.validatorFactory=function(A){return new g(A)};function o(C){var I=C||j.uid(),E=j.ku4webApp,A=j.mediator("ku4webApp_"+I),H=E.serviceFactory(A,E.config.services),B=E.socketFactory(A,E.config.sockets),D=E.storeFactory(A,E.config.collections),G=E.validatorFactory(E.config.validators);this._state=j.ku4webApp.state("__ku4appStarted__");this.modelFactory=E.modelFactory(A,H,B,D,G,this._state);this.templateFactory=E.templateFactory(E.config.templates);this.formFactory=E.formFactory(E.config.forms);this.mediator=A;var F=j.ku4webApp.$stateMachine;this.stateMachine=(j.isFunction(F))?F(A,this.modelFactory):null;this.navigator=E.navigator(this.modelFactory,E.config.navigator,this.stateMachine)}o.prototype={logErrors:function(){this.mediator.logErrors();this.navigator.logErrors();return this},throwErrors:function(){this.mediator.throwErrors();this.navigator.throwErrors();return this},catchErrors:function(){this.mediator.catchErrors();this.navigator.catchErrors();return this}};j.ku4webApp.app=function(A){return new o(A)};function y(C,A,E){var D=j.str.format("$.ku4webApp.{0}",C),B=j.str.format("Requires a valid {0}. {0}= {1}",A,E);if(!j.exists(E)){throw j.ku4exception(D,B)}else{return E}}})(ku4js);