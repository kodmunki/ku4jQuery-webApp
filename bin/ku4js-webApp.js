(function(v){$.ku4webApp={config:{templates:{}},templates:{},models:{},controllers:{},views:{}};function d(l){d.base.call(this);$.list(l).each(this._add,this)}d.prototype={_add:function(l){var A=$[l.type](l.selector);if($.exists(l.spec)){A.spec(l.spec)}if($.exists(l.maxDims)){A.maxDims(l.maxDims)}if((l.required===true)&&$.isFunction(A.required)){A.required()}if($.exists(l.format)&&$.isFunction(A.format)){A.format(l.format)}if($.isNullOrEmpty(A.dom().name)){throw $.ku4exception("form","Form requires all field DOM elements have a valid 'name' attribute")}else{this.add(A.dom().name,A)}}};$.Class.extend(d,$.form.Class);$.ku4webApp.form=function(l){return new d(l)};function h(l){this._container=$(l);this._display="css-responsebox-show"}h.prototype={show:function(l){this._container.html(l).addClass(this._display)},hide:function(){this._container.html("").removeClass(this._display)}};$.ku4webApp.responsebox=function(l){return new h(l)};function k(l){this._config=l}k.prototype={validate:function(B){var l=this._config,D=true,A=$.hash({}),C=B||$.dto();$.list(l).each(function(H){var F=H.name,E=H.spec,G=H.message,I=C.find(F);if(E.isSatisfiedBy(I)){return}D=false;A.add(F,G)});return{isValid:function(){return D},messages:function(){return A.toObject()}}}};$.ku4webApp.validator=function(l){return new k(l)};function c(B,A,l){this._modelFactory=y("controllers","modelFactory",B);this._formFactory=y("controllers","formFactory",A);this._navigator=l}c.prototype={$model:function(l){return this._modelFactory.create(l)},$form:function(l){return this._formFactory.create(l)},$navigator:function(){return this._navigator}};$.ku4webApp.abstractController=c;$.ku4webApp.controller=function(A,B){function l(E,D,C){l.base.call(this,E,D,C)}l.prototype=B;$.Class.extend(l,c);$.ku4webApp.controllers[A]=function(E){var C=$.str.format("$.ku4webApp.controllers.{0}",A),D=$.str.format("Requires a valid app. app= {0}",E);if(!$.exists(E)){throw $.ku4exception(C,D)}return new l(E.modelFactory,E.formFactory,E.navigator)}};function s(D,l,A,E,B,C){this._mediator=y("models","mediator",D);this._serviceFactory=y("models","serviceFactory",l);this._socketFactory=y("models","socketFactory",A);this._storeFactory=y("models","storeFactory",E);this._validatorFactory=y("models","validatorFactory",B);this._appState=C;this._state=$.ku4webApp.state()}s.prototype={$mediator:function(){return this._mediator},$collection:function(l){return this._storeFactory.create(l)},$service:function(l){return this._serviceFactory.create(l)},$socket:function(l){return this._socketFactory.create(l)},$validator:function(l){return this._validatorFactory.create(l)},$state:function(){return this._state},$appState:function(l){if(!$.exists(l)){return this._appState}this._appState.set(l);return this},$notify:function(){var l=this._mediator;l.notify.apply(l,arguments);return this}};$.ku4webApp.abstractModel=s;$.ku4webApp.model=function(A,B,C){function l(H,D,E,I,F,G){l.base.call(this,H,D,E,I,F,G)}l.prototype=B;$.Class.extend(l,s);$.ku4webApp.models[A]=function(H,D,E,I,F,G){var J=new l(H,D,E,I,F,G);if($.exists(C)){$.hash(C).each(function(N){var K=N.key,L=N.value,P=$.str.format("ku4webApp.model.{0}_{1}",A,L),O=J[L];try{H.unsubscribe(K,P).subscribe(K,O,J,P)}catch(M){throw $.ku4exception("$.ku4webApp.model",$.str.format("$.ku4webApp.model.{0} cannot subscribe to mediator with name: {1} or method: {2}.\n\nmessage:{3}\n\n",A,K,L,M.message))}})}return J}};function z(C,B,A){this._mediator=C;this._config=A;var l=$.service(B)[A.verb]().uri(A.uri);l.contentType(A.contentType);if($.exists(A.success)){l.onSuccess(function(D){C.notify(A.success,D,l.processId())},this,A.success)}if($.exists(A.error)){l.onError(function(D){C.notify(A.error,D,l.processId())},this,A.success)}if($.exists(A.complete)){l.onError(function(D){C.notify(A.complete,D,l.processId())},this,A.complete)}this._service=l}z.prototype={cache:function(){this._service.cache();return this},noCache:function(){this._service.noCache();return this},lock:function(){this._service.lock();return this},unlock:function(){this._service.unlock();return this},abort:function(){this._service.abort();return this},call:function(l){this._service.call(l);return this}};$.ku4webApp.service=function(B,A,l){return new z(B,A,l)};var w,n;function r(){if($.isUndefined(w)){w=($.exists(n))?n():null}return w}function p(B,A){if(!$.exists(A.event)){throw new Error("Invalid socket event configuration")}this._event=A.event;var l=r();if(!$.exists(l)){throw new Error("Missing socket.io dependency. Add socket.io to your application.")}if($.exists(A.success)){l.on(this._event,function(C){B.notify(A.success,C)})}if($.exists(A.error)){l.on("error",function(C){B.notify(A.error,C)})}}p.prototype={call:function(l){r().emit(this._event,l)}};$.ku4webApp.socket=function(A,l){return new p(A,l)};function j(l){this._value=l;this._data=$.hash()}j.prototype={is:function(l){return this._value===l},set:function(l){this._value=l;return this},read:function(l){return this._data.findValue(l)},write:function(l,A){this._data.update(l,A);return this}};$.ku4webApp.state=function(l){return new j(l)};function m(B,l,A,C){this._mediator=B;this._config=l;this._key=A;this._collection=C}m.prototype={init:function(B,D,A){var l=D||function(){},C=A||this;this.__collection(function(E,F){if($.exists(E)){l.call(C,E,null)}else{F.init(B).save(function(G){l.call(C,G,this)},this)}},this);return this},find:function(E,D,B){var A=this.__config(),l=D||function(){},C=B||this;this.__collection(function(G,H){if($.exists(G)){l.call(C,G,null)}else{var F=H.find(E);l.call(C,null,F);if($.exists(A.find)){this._mediator.notify(A.find,data)}}},this)},insert:function(D,F,B){var A=this.__config(),C=$.str.format('Cannot insert invalid type: {1} into Collection["{0}"]',A.name,D),l=F||function(){},E=B||this;this.__collection(function(G,H){if($.exists(G)){l.call(E,G,null)}else{if(!$.exists(D)){throw $.ku4exception("Collection",C)}else{H.insert(D).save(function(I){l.call(E,I,this);if($.exists(A.insert)){this._mediator.notify(A.insert,H)}},this)}}},this);return this},insertList:function(C,E,B){var A=this.__config(),l=E||function(){},D=B||this;this.__collection(function(F,G){if($.exists(F)){l.call(D,F,null)}else{G.insertList(C).save(function(H){l.call(D,H,this);if($.exists(A.insert)){this._mediator.notify(A.insert,G)}},this)}},this);return this},update:function(D,B,E,G){var l=this.__config(),F=$.str.format('Cannot update type: {1} into Collection["{0}"]',l.name,B),H=E||function(){},C=G||this;if(!$.exists(B)){throw $.ku4exception("Collection",F)}var A=($.exists(B.toObject))?B.toObject():B;this.__collection(function(I,J){if($.exists(I)){H.call(C,I,null)}else{J.update(D,A).save(function(K){H.call(C,K,this);if($.exists(l.update)){this._mediator.notify(l.update,J)}},this)}},this);return this},remove:function(D,H,I){var G=$.isFunction(D),F=(G)?null:D,J=(G)?D:H,l=(G)?H:I,C=($.exists(F)&&$.exists(F.toObject))?F.toObject():F,B=this.__config(),A=J||function(){},E=l||this;this.__collection(function(K,L){if($.exists(K)){A.call(E,K,null)}else{L.remove(C).save(function(M){A.call(E,M,this);if($.exists(B.remove)){this._mediator.notify(B.remove,L)}},this)}},this);return this},join:function(){var C=this._config,l=arguments[0],K=arguments[1],J=arguments[2],I=arguments[3],G=arguments[4],E=arguments[5],F=arguments.length==3,H=arguments.length==4,N=arguments.length==5,L=C[l],D=($.exists(L))?L.name:l,O=(F)?J:(H)?I:G,A=(F)?I:(H)?G:E,B=O||function(){},M=A||this;this.__collection(function(Q,P){this.__store().read(D,function(U,T){var V=(function(){if(F){return P.join(T,K)}if(H){return P.join(T,K,J)}if(N){return P.join(T,K,J,I)}return null})();if(!$.exists(V)){B.call(M,$.ku4exception("$.ku4webApp.store","Join exception"))}else{var W=V.name(),R=$.hash(C).replicate().add(W,{name:W}).toObject(),S=new m(this._mediator,R,W,V);B.call(M,U,S)}},this)},this)},exec:function(B,D,A){var l=D||function(){},C=A||this;this.__collection(function(F,G){if($.exists(F)){l.call(C,F,null)}else{var E=new m(this._mediator,this._config,this._key,G.exec(B));l.call(C,F,E)}},this);return this},__config:function(){return y("Collection","config",this._config[this._key])},__store:function(){var l=this._config.ku4StoreType;switch(l){case"memory":return $.ku4memoryStore();case"indexedDB":return $.ku4indexedDbStore();default:return $.ku4localStorageStore()}},__collection:function(C,l){var A=this._collection,B=l||this;if($.exists(A)){C.call(B,null,A)}else{this.__store().read(this.__config().name,C,B)}}};$.ku4webApp.store=function(B,l,A,C){return new m(B,l,A,C)};function e(C,A){this._modelFactory=C;this._config=A;this._routes=($.exists(A))?$.hash(A.ku4routes):$.hash();this._catchAll=this._routes.find("ku4default");this._throwErrors=0;this._mute=false;var B=this;function l(D){if(!B._mute){B.execute(B.read())}B._mute=false}if($.exists(window.addEventListener)){window.addEventListener("hashchange",l)}else{if($.exists(window.attachEvent)){window.attachEvent("onhashchange",l)}}}e.prototype={throwErrors:function(){this._throwErrors=2;return this},logErrors:function(){this._throwErrors=1;return this},catchErrors:function(){this._throwErrors=0;return this},hashEquals:function(l){return this.read()==l},hashContainsArguments:function(){return/_ku4_/.test(this.read())},hash:function(l){return($.exists(l))?this.write(l):this.read().split("_ku4_")[0]},read:function(){return location.hash.substr(1)},write:function(){var l=Array.prototype.slice.call(arguments),B=l.shift(),A=(l.length>0)?this._encodeArgs(l):"",C=($.isNullOrEmpty(A))?B:$.str.build(B,"_ku4_",A);if(this.read()==C){return this}this._mute=true;location.hash=C;return this},execute:function(){this.write.apply(this,arguments);this._execute(this.read());return this},executeOrDefault:function(C,B){var l=this._config;if(!$.exists(l)||!$.isString(C)){return}var A=C.split("_ku4_")[0];return($.exists(l[A]))?this._execute(C):this._execute(B)},route:function(){var B=this.hashContainsArguments(),C=(B)?this.hash()+"*":this.hash(),l=this._routes.findValue(C),D=(B)?"_ku4_"+this._readArgs():"",A=($.exists(l))?l+D:"";this.executeOrDefault(A,this._routes.findValue("ku4default"))},tryRouteOrHash:function(A){try{this.route()}catch(l){this.execute(A)}},forward:function(l){if($.exists(l)){this._setEventListener(l)}window.history.forward();return this},back:function(l){if($.exists(l)){this._setEventListener(l)}window.history.back();return this},clear:function(){return this.hash("")},_execute:function(I){var l=this._config;if(!$.exists(l)){return this}var H=I.split("_ku4_"),K=H[0],F=(H.length>1)?this._decodeArgs(H[1]):[],B=l[K];if(!$.exists(B)){return this}var E=B.model,J=B.method,C=this._modelFactory.create(E);if($.exists(E)&&$.exists(J)){try{C[J].apply(C,F)}catch(D){try{var G=l[this._catchAll],A=this._modelFactory.create(G.model);A[G.method]()}catch(D){this._alertException(D,E,J)}}}return this},_readArgs:function(){return this.read().split("_ku4_")[1]},_encodeArgs:function(l){if($.isNullOrEmpty(l)){return""}return $.str.encodeBase64($.json.serialize(l))},_decodeArgs:function(l){if($.isNullOrEmpty(l)){return""}return $.json.deserialize($.str.decodeBase64(l))},_setEventListener:function(l){if($.exists(window.addEventListener)){window.addEventListener("hashchange",function(A){window.removeEventListener("hashchange",arguments.callee);setTimeout(function(){l()},800)})}else{if($.exists(window.attachEvent)){window.attachEvent("onhashchange",function(A){window.detachEvent("onhashchange",arguments.callee);setTimeout(function(){l()},800)})}}},_alertException:function(D,l,A){var C=this._throwErrors,B=$.ku4exception("$.ku4webApp.navigator",$.str.format("{0}. Model: {1}, Method: {2}",D.message,l,A));if(C==2){throw B}if(C==1){$.ku4Log(B.message)}}};$.ku4webApp.navigator=function(A,l){return new e(A,l)};function u(l){this._config=y("templates","config",l)}u.prototype={$config:function(l){return($.exists(l))?this._config[l]:this._config},$forms:function(l){return($.exists(l))?this._config.forms[l]:this._config.forms},$views:function(l){return($.exists(l))?this._config.views[l]:this._config.views},$render:function(l,A,B){return $.str.render(l,A,B)},$renderList:function(C,B,E,D){var l="",F=(!$.isFunction(E))?E:null,A=($.isFunction(E))?E:($.isFunction(D))?D:function(G){return G};$.list(B).each(function(G){l+=this.$render(C,A(G),F)},this);return l},$renderListWithAction:function(B,C,D){var l="",A=D||function(E){return E};$.list(B).each(function(E){l+=C.call(this,A(E))},this);return l}};$.ku4webApp.abstractTemplate=u;$.ku4webApp.template=function(l,B){function A(C){A.base.call(this,C)}A.prototype=B;$.Class.extend(A,u);$.ku4webApp.templates[l]=function(C){var D=y($.str.format("templates.{0}",l),"config",C);return new A(D)}};function a(B,A,l){this._templateFactory=y("views","templateFactory",B);this._formFactory=y("views","formFactory",A);this._navigator=y("views","navigator",l);this._state=$.ku4webApp.state()}a.prototype={$template:function(l){return this._templateFactory.create(l)},$form:function(l){return this._formFactory.create(l)},$navigator:function(){return this._navigator},$state:function(){return this._state}};$.ku4webApp.abstractView=a;$.ku4webApp.__views={};$.ku4webApp.view=function(A,B,C){function l(F,E,D){l.base.call(this,F,E,D)}l.prototype=B;$.Class.extend(l,a);$.ku4webApp.views[A]=function(F){var D=$.str.format("$.ku4webApp.views.{0}",A),E=$.str.format("Requires a valid app. app= {0}",F);if(!$.exists(F)){throw $.ku4exception(D,E)}if(!$.exists($.ku4webApp.__views[A])){var G=new l(F.templateFactory,F.formFactory,F.navigator);if($.exists(C)){$.hash(C).each(function(K){var H=K.key,I=K.value,M=$.str.format("ku4webApp.view_{0}_{1}",A,I),L=G[I];try{F.mediator.unsubscribe(H,M).subscribe(H,L,G,M)}catch(J){throw $.ku4exception("$.ku4webApp.view",$.str.format("$.ku4webApp.view.{0} cannot subscribe to mediator with name: {1} or key: {2}.\n\nmessage:{3}\n\n",A,H,I,J.message))}})}$.ku4webApp.__views[A]=G}return $.ku4webApp.__views[A]}};function f(l){this._config=l}f.prototype={create:function(l){return $.ku4webApp.form(this._config[l])}};$.ku4webApp.formFactory=function(l){return new f(l)};function i(D,l,A,E,B,C){var F=$.hash();$.hash($.ku4webApp.models).each(function(G){F.add(G.key,G.value(D,l,A,E,B,C))},this);this._models=F}i.prototype={create:function(l){return this._models.find(l)}};$.ku4webApp.modelFactory=function(D,l,A,E,B,C){return new i(D,l,A,E,B,C)};function b(B,l){var A=$.hash();$.hash(l).each(function(C){A.add(C.key,$.ku4webApp.service(B,C.key,C.value))},this);this._services=A}b.prototype={create:function(l){return this._services.find(l)}};$.ku4webApp.serviceFactory=function(A,l){return new b(A,l)};function t(B,l){var A=$.hash();$.hash(l).each(function(C){A.add(C.key,$.ku4webApp.socket(B,C.value))},this);this._sockets=A}t.prototype={create:function(l){return this._sockets.find(l)}};$.ku4webApp.socketFactory=function(A,l){return new t(A,l)};function x(A,l){this._mediator=A;this._config=l}x.prototype={create:function(l){return $.ku4webApp.store(this._mediator,this._config,l)}};$.ku4webApp.storeFactory=function(A,l){return new x(A,l)};function q(l){this._config=l}q.prototype={create:function(l){return $.ku4webApp.templates[l](this._config)}};$.ku4webApp.templateFactory=function(l){return new q(l)};function g(l){this._config=l}g.prototype={create:function(l){return $.ku4webApp.validator(this._config[l])}};$.ku4webApp.validatorFactory=function(l){return new g(l)};function o(A){var l=A||$.uid(),G=$.ku4webApp,E=$.mediator("ku4webApp_"+l),B=G.serviceFactory(E,G.config.services),C=G.socketFactory(E,G.config.sockets),F=G.storeFactory(E,G.config.collections),D=G.validatorFactory(G.config.validators);this._state=$.ku4webApp.state("__ku4appStarted__");this.modelFactory=G.modelFactory(E,B,C,F,D,this._state);this.templateFactory=G.templateFactory(G.config.templates);this.formFactory=G.formFactory(G.config.forms);this.navigator=G.navigator(this.modelFactory,G.config.navigator);this.mediator=E}o.prototype={logErrors:function(){this.mediator.logErrors();this.navigator.logErrors();return this},throwErrors:function(){this.mediator.throwErrors();this.navigator.throwErrors();return this},catchErrors:function(){this.mediator.catchErrors();this.navigator.catchErrors();return this}};$.ku4webApp.app=function(l){return new o(l)};function y(B,l,D){var C=$.str.format("$.ku4webApp.{0}",B),A=$.str.format("Requires a valid {0}. {0}= {1}",l,D);if(!$.exists(D)){throw $.ku4exception(C,A)}else{return D}}})();