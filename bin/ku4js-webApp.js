(function(v){$.ku4webApp={config:{templates:{}},templates:{},models:{},controllers:{},views:{}};function e(l){e.base.call(this);$.list(l).each(this._add,this)}e.prototype={_add:function(l){var A=$[l.type](l.selector);if($.exists(l.spec)){A.spec(l.spec)}if($.exists(l.maxDims)){A.maxDims(l.maxDims)}if(l.required&&$.exists(A.required)){A.required()}if($.isNullOrEmpty(A.dom().name)){throw $.ku4exception("form","Form requires all field DOM elements have a valid 'name' attribute")}else{this.add(A.dom().name,A)}}};$.Class.extend(e,$.form.Class);$.ku4webApp.form=function(l){return new e(l)};function i(l){this._container=$(l);this._display="css-responsebox-show"}i.prototype={show:function(l){this._container.html(l).addClass(this._display)},hide:function(){this._container.html("").removeClass(this._display)}};$.ku4webApp.responsebox=function(l){return new i(l)};function m(l){this._config=l}m.prototype={validate:function(B){var l=this._config,D=true,A=$.hash({}),C=B||$.dto();$.list(l).each(function(H){var F=H.name,E=H.spec,G=H.message,I=C.find(F);if(E.isSatisfiedBy(I)){return}D=false;A.add(F,G)});return{isValid:D,messages:A.toObject()}}};$.ku4webApp.validator=function(l){return new m(l)};function d(B,A,l){this._modelFactory=y("controllers","modelFactory",B);this._formFactory=y("controllers","formFactory",A);this._navigator=l}d.prototype={$model:function(l){return this._modelFactory.create(l)},$form:function(l){return this._formFactory.create(l)},$navigator:function(){return this._navigator}};$.ku4webApp.abstractController=d;$.ku4webApp.controller=function(A,B){function l(E,D,C){l.base.call(this,E,D,C)}l.prototype=B;$.Class.extend(l,d);$.ku4webApp.controllers[A]=function(E){var C=$.str.format("$.ku4webApp.controllers.{0}",A),D=$.str.format("Requires a valid app. app= {0}",E);if(!$.exists(E)){throw $.ku4exception(C,D)}return new l(E.modelFactory,E.formFactory,E.navigator)}};function s(C,l,A,D,B){this._mediator=y("models","mediator",C);this._serviceFactory=y("models","serviceFactory",l);this._socketFactory=y("models","socketFactory",A);this._storeFactory=y("models","storeFactory",D);this._validatorFactory=y("models","validatorFactory",B);this._state=new k()}s.prototype={$collection:function(l){return this._storeFactory.create(l)},$service:function(l){return this._serviceFactory.create(l)},$socket:function(l){return this._socketFactory.create(l)},$validator:function(l){return this._validatorFactory.create(l)},$state:function(){return this._state},$appState:function(l){if(!$.exists(l)){return a}a=new k(l);return this},$notify:function(){var l=this._mediator;l.notify.apply(l,arguments);return this}};$.ku4webApp.abstractModel=s;$.ku4webApp.model=function(A,B,C){function l(G,D,E,H,F){l.base.call(this,G,D,E,H,F)}l.prototype=B;$.Class.extend(l,s);$.ku4webApp.models[A]=function(G,D,E,H,F){var I=new l(G,D,E,H,F);if($.exists(C)){$.hash(C).each(function(M){var J=M.key,K=M.value,O=$.str.format("ku4webApp.model.{0}_{1}",A,K),N=I[K];try{G.unsubscribe(J,O).subscribe(J,N,I,O)}catch(L){throw $.ku4exception("$.ku4webApp.model",$.str.format("$.ku4webApp.model.{0} cannot subscribe to mediator with name: {1} or method: {2}.\n\nmessage:{3}\n\n",A,J,K,L.message))}})}return I}};function z(C,B,A){this._mediator=C;this._config=A;var l=$.service(B)[A.verb]().uri(A.uri);l.contentType(A.contentType);if($.exists(A.success)){l.onSuccess(function(D){C.notify(A.success,D,l.processId())},this,A.success)}if($.exists(A.error)){l.onError(function(D){C.notify(A.error,D,l.processId())},this,A.success)}if($.exists(A.complete)){l.onError(function(D){C.notify(A.complete,D,l.processId())},this,A.complete)}this._service=l}z.prototype={cache:function(){this._service.cache();return this},noCache:function(){this._service.noCache();return this},lock:function(){this._service.lock();return this},unlock:function(){this._service.unlock();return this},abort:function(){this._service.abort();return this},call:function(l){this._service.call(l);return this}};$.ku4webApp.service=function(B,A,l){return new z(B,A,l)};var w;function r(){if($.isUndefined(w)){w=($.exists(io))?io():null}return w}function p(B,A){if(!$.exists(A.event)){throw new Error("Invalid socket event configuration")}this._event=A.event;var l=r();if($.exists(A.success)){l.on(this._event,function(C){B.notify(A.success,C)})}if($.exists(A.error)){l.on("error",function(C){B.notify(A.error,C)})}}p.prototype={call:function(l){console.log(r(),this._event,l);r().emit(this._event,l)}};$.ku4webApp.socket=function(A,l){return new p(A,l)};function k(l){this._value=l;this._data=$.hash()}k.prototype={is:function(l){return this._value===l},set:function(l){this._value=l;return this},read:function(l){return this._data.findValue(l)},write:function(l,A){this._data.update(l,A);return this}};var a=new k("__ku4appStarted__");function n(B,l,A,C){this._mediator=B;this._config=l;this._key=A;this._collection=C}n.prototype={init:function(l){this._collection=null;this.__collection().init(l).save();return this},find:function(B){var l=this.__config(),A=this.__collection().find(B);if($.exists(l.find)){this._mediator.notify(l.find,A)}return A},insert:function(B){var l=this.__config(),A=$.str.format('Cannot insert invalid type: {1} into Collection["{0}"]',l.name,B),C=this.__collection();if(!$.exists(B)){throw $.ku4exception("Collection",A)}C.insert(B).save();if($.exists(l.insert)){this._mediator.notify(l.insert,C)}return this},insertList:function(l){this.__collection().insertList(l).save();return this},update:function(E,B){var A=this.__config(),l=$.str.format('Cannot update type: {1} into Collection["{0}"]',A.name,B);if(!$.exists(B)){throw $.ku4exception("Collection",l)}var C=($.exists(B.toObject))?B.toObject():B;var D=this.__collection().update(E,C).save();if($.exists(A.update)){this._mediator.notify(A.update,D)}return this},remove:function(A){var B=($.exists(A)&&$.exists(A.toObject))?A.toObject():A,l=this.__config(),C=this.__collection().remove(B).save();if($.exists(l.remove)){this._mediator.notify(l.remove,C)}return this},join:function(){var C=this._config,l=arguments[0],I=arguments[1],B=arguments[2],K=arguments[3],J=C[l],E=($.exists(J))?J.name:l,G=this.__collection(),D=$.ku4store().read(E),A=G.join(D,I,B,K),H=A.name(),F=$.hash(C).replicate().add(H,{name:H}).toObject();return new n(this._mediator,F,H,A)},exec:function(l){this._collection=this.__collection().exec(l);return this},__config:function(){return y("Collection","config",this._config[this._key])},__collection:function(){var l=this._collection;return($.exists(l))?l:$.ku4store().read(this.__config().name)}};$.ku4webApp.store=function(B,l,A,C){return new n(B,l,A,C)};function f(C,A){this._modelFactory=C;this._config=A;this._notify=true;var B=this;function l(){if(B._notify){B.execute(B.read())}B._notify=true}if($.exists(window.addEventListener)){window.addEventListener("hashchange",l)}else{if($.exists(window.attachEvent)){window.attachEvent("onhashchange",l)}}}f.prototype={hashEquals:function(l){return this.read()==l},hash:function(l){return($.exists(l))?this.write(l,true):this.read()},read:function(){return location.hash.substr(1)},write:function(B,A){var l=this.read();this._notify=(A)?false:true;location.hash=B;return this},forward:function(){window.history.forward();return this},back:function(){window.history.back();return this},execute:function(D){var C=this._config;if(!$.exists(C)){return}var G=C[D];if(!$.exists(G)){return}var l=G.model,A=G.method,F=this._modelFactory;if($.exists(l)&&$.exists(A)){try{var B=F.create(l);B[A]()}catch(E){}}return this},executeOrDefault:function(B,A){var l=this._config;if(!$.exists(l)){return}var C=l[B];return($.exists(C))?this.execute(B):this.execute(A)}};$.ku4webApp.navigator=function(A,l){return new f(A,l)};function u(l){this._config=y("templates","config",l)}u.prototype={$config:function(l){return($.exists(l))?this._config[l]:this._config},$forms:function(l){return($.exists(l))?this._config.forms[l]:this._config.forms},$views:function(l){return($.exists(l))?this._config.views[l]:this._config.views},$render:function(l,A){return $.str.render(l,A)},$renderList:function(B,A){var l="";$.list(A).each(function(C){l+=this.$render(B,C)},this);return l},$renderListWithAction:function(A,B){var l="";$.list(A).each(function(C){l+=B.call(this,C)},this);return l}};$.ku4webApp.abstractTemplate=u;$.ku4webApp.template=function(l,B){function A(C){A.base.call(this,C)}A.prototype=B;$.Class.extend(A,u);$.ku4webApp.templates[l]=function(C){var D=y($.str.format("templates.{0}",l),"config",C);return new A(D)}};function b(B,A,l){this._templateFactory=y("views","templateFactory",B);this._formFactory=y("views","formFactory",A);this._navigator=y("views","navigator",l);this._state=new k()}b.prototype={$template:function(l){return this._templateFactory.create(l)},$form:function(l){return this._formFactory.create(l)},$navigator:function(){return this._navigator},$state:function(){return this._state}};$.ku4webApp.abstractView=b;$.ku4webApp.__views={};$.ku4webApp.view=function(A,B,C){function l(F,E,D){l.base.call(this,F,E,D)}l.prototype=B;$.Class.extend(l,b);$.ku4webApp.views[A]=function(F){var D=$.str.format("$.ku4webApp.views.{0}",A),E=$.str.format("Requires a valid app. app= {0}",F);if(!$.exists(F)){throw $.ku4exception(D,E)}if(!$.exists($.ku4webApp.__views[A])){var G=new l(F.templateFactory,F.formFactory,F.navigator);if($.exists(C)){$.hash(C).each(function(K){var H=K.key,I=K.value,M=$.str.format("ku4webApp.view_{0}_{1}",A,I),L=G[I];try{F.mediator.unsubscribe(H,M).subscribe(H,L,G,M)}catch(J){throw $.ku4exception("$.ku4webApp.view",$.str.format("$.ku4webApp.view.{0} cannot subscribe to mediator with name: {1} or key: {2}.\n\nmessage:{3}\n\n",A,H,I,J.message))}})}$.ku4webApp.__views[A]=G}return $.ku4webApp.__views[A]}};function g(l){this._config=l}g.prototype={create:function(l){return $.ku4webApp.form(this._config[l])}};$.ku4webApp.formFactory=function(l){return new g(l)};function j(C,l,A,D,B){var E=$.hash();$.hash($.ku4webApp.models).each(function(F){E.add(F.key,F.value(C,l,A,D,B))},this);this._models=E}j.prototype={create:function(l){return this._models.find(l)}};$.ku4webApp.modelFactory=function(C,l,A,D,B){return new j(C,l,A,D,B)};function c(B,l){var A=$.hash();$.hash(l).each(function(C){A.add(C.key,$.ku4webApp.service(B,C.key,C.value))},this);this._services=A}c.prototype={create:function(l){return this._services.find(l)}};$.ku4webApp.serviceFactory=function(A,l){return new c(A,l)};function t(B,l){var A=$.hash();$.hash(l).each(function(C){A.add(C.key,$.ku4webApp.socket(B,C.value))},this);this._sockets=A}t.prototype={create:function(l){return this._sockets.find(l)}};$.ku4webApp.socketFactory=function(A,l){return new t(A,l)};function x(A,l){this._mediator=A;this._config=l}x.prototype={create:function(l){return $.ku4webApp.store(this._mediator,this._config,l)}};$.ku4webApp.storeFactory=function(A,l){return new x(A,l)};function q(l){this._config=l}q.prototype={create:function(l){return $.ku4webApp.templates[l](this._config)}};$.ku4webApp.templateFactory=function(l){return new q(l)};function h(l){this._config=l}h.prototype={create:function(l){return $.ku4webApp.validator(this._config[l])}};$.ku4webApp.validatorFactory=function(l){return new h(l)};function o(A){var l=A||$.uid(),G=$.ku4webApp,E=$.mediator("ku4webApp_"+l),B=G.serviceFactory(E,G.config.services),C=G.socketFactory(E,G.config.sockets),F=G.storeFactory(E,G.config.collections),D=G.validatorFactory(G.config.validators);this.modelFactory=G.modelFactory(E,B,C,F,D);this.templateFactory=G.templateFactory(G.config.templates);this.formFactory=G.formFactory(G.config.forms);this.navigator=G.navigator(this.modelFactory,G.config.navigator);this.mediator=E}o.prototype={logErrors:function(){this.mediator.logErrors();return this},throwErrors:function(){this.mediator.throwErrors();return this}};$.ku4webApp.app=function(l){return new o(l)};function y(B,l,D){var C=$.str.format("$.ku4webApp.{0}",B),A=$.str.format("Requires a valid {0}. {0}= {1}",l,D);if(!$.exists(D)){throw $.ku4exception(C,A)}else{return D}}})();