(function(q){$.ku4webApp={config:{templates:{}},templates:{},models:{},controllers:{},views:{}};function d(l){d.base.call(this);$.list(l).each(this._add,this)}d.prototype={_add:function(l){var u=$[l.type](l.selector);if($.exists(l.spec)){u.spec(l.spec)}if(l.required&&$.exists(u.required)){u.required()}if($.isNullOrEmpty(u.dom().name)){throw $.ku4exception("form","Form requires all field DOM elements have a valid 'name' attribute")}else{this.add(u.dom().name,u)}}};$.Class.extend(d,$.form.Class);$.ku4webApp.form=function(l){return new d(l)};function g(l){this._container=$(l);this._display="css-responsebox-show"}g.prototype={show:function(l){this._container.html(l).addClass(this._display)},hide:function(){this._container.html("").removeClass(this._display)}};$.ku4webApp.responsebox=function(l){return new g(l)};function j(l){this._config=l}j.prototype={validate:function(v){var l=this._config,x=true,u=$.hash({}),w=v||$.dto();$.list(l).each(function(B){var z=B.name,y=B.spec,A=B.message,C=w.find(z);if(y.isSatisfiedBy(C)){return}x=false;u.add(z,A)});return{isValid:x,messages:u.toObject()}}};$.ku4webApp.validator=function(l){return new j(l)};function m(){var x=$.ku4webApp,v=$.mediator(),l=x.serviceFactory(v,x.config.services),w=x.storeFactory(v,x.config.collections),u=x.validatorFactory(x.config.validators);this.modelFactory=x.modelFactory(v,l,w,u);this.templateFactory=x.templateFactory(x.config.templates);this.formFactory=x.formFactory(x.config.forms);this.mediator=v}m.prototype={logErrors:function(){this.mediator.logErrors();return this},throwErrors:function(){this.mediator.throwErrors();return this}};$.ku4webApp.app=function(){return new m()};function s(v,l,x){var w=$.str.format("$.ku4webApp.{0}",v),u=$.str.format("Requires a valid {0}. {0}= {1}",l,x);if(!$.exists(x)){throw $.ku4exception(w,u)}else{return x}}function c(u,l){this._modelFactory=s("controllers","modelFactory",u);this._formFactory=s("controllers","formFactory",l)}c.prototype={$model:function(l){return this._modelFactory.create(l)},$form:function(l){return this._formFactory.create(l)}};$.ku4webApp.abstractController=c;$.ku4webApp.controller=function(u,v){function l(y,w,x){l.base.call(this,y,w,x)}l.prototype=v;$.Class.extend(l,c);$.ku4webApp.controllers[u]=function(y){var w=$.str.format("$.ku4webApp.controllers.{0}",u),x=$.str.format("Requires a valid app. app= {0}",y);if(!$.exists(y)){throw $.ku4exception(w,x)}return new l(y.modelFactory,y.formFactory,y.validatorFactory)}};function o(v,l,w,u){this._mediator=s("models","mediator",v);this._serviceFactory=s("models","serviceFactory",l);this._storeFactory=s("models","storeFactory",w);this._validatorFactory=s("models","validatorFactory",u);this._state=new i()}o.prototype={$collection:function(l){return this._storeFactory.create(l)},$service:function(l){return this._serviceFactory.create(l)},$validator:function(l){return this._validatorFactory.create(l)},$state:function(l){if(!$.exists(l)){return this._state}this._state=new i(l);return this},$notify:function(){var l=this._mediator;l.notify.apply(l,arguments);return this}};$.ku4webApp.abstractModel=o;$.ku4webApp.model=function(u,v,w){function l(z,x,A,y){l.base.call(this,z,x,A,y)}l.prototype=v;$.Class.extend(l,o);$.ku4webApp.models[u]=function(z,x,A,y){var B=new l(z,x,A,y);if($.exists(w)){$.hash(w).each(function(D){var C=D.key;z.unsubscribe(C,u).subscribe(C,B[D.value],B,u)})}return B}};function t(u,l){this._mediator=u;this._config=l;this._noCache=false}t.prototype={noCache:function(){this._noCache=true;return this},call:function(w){var u=this._config,v=this._mediator,l=$.service()[u.verb]().uri(u.uri);l.contentType(u.contentType);if(this._noCache){l.noCache()}l.onSuccess(function(x){if($.exists(u.success)){v.notify(x,l.processId(),u.success)}},this).onError(function(x){if($.exists(u.error)){v.notify(x,l.processId(),u.error)}},this).call(w);return l}};$.ku4webApp.service=function(u,l){return new t(u,l)};function i(l){this._value=l}i.prototype={is:function(l){return this._value===l}};function k(v,l,u,w){this._mediator=v;this._config=l;this._key=u;this._collection=w}k.prototype={init:function(l){this._collection=null;this.__collection().init(l).save();return this},find:function(v){var l=this.__config(),u=this.__collection().find(v);if($.exists(l.find)){this._mediator.notify(u,l.find)}return u},insert:function(v){var l=this.__config(),u=$.str.format('Cannot insert invalid type: {1} into Collection["{0}"]',l.name,v),w=this.__collection();if(!$.exists(v)){throw $.ku4exception("Collection",u)}w.insert(v).save();if($.exists(l.insert)){this._mediator.notify(w,l.insert)}return this},insertList:function(l){this.__collection().insertList(l).save();return this},update:function(y,v){var u=this.__config(),l=$.str.format('Cannot update type: {1} into Collection["{0}"]',u.name,v);if(!$.exists(v)){throw $.ku4exception("Collection",l)}var w=($.exists(v.toObject))?v.toObject():v;var x=this.__collection().update(y,w).save();if($.exists(u.update)){this._mediator.notify(x,u.update)}return this},remove:function(u){var v=($.exists(u)&&$.exists(u.toObject))?u.toObject():u,l=this.__config(),w=this.__collection().remove(v).save();if($.exists(l.remove)){this._mediator.notify(w,l.remove)}return this},join:function(){var w=this._config,l=arguments[0],C=arguments[1],v=arguments[2],E=arguments[3],D=w[l],y=($.exists(D))?D.name:l,A=this.__collection(),x=$.ku4store().read(y),u=A.join(x,C,v,E),B=u.name(),z=$.hash(w).replicate().add(B,{name:B}).toObject();return new k(this._mediator,z,B,u)},exec:function(l){this._collection=this.__collection().exec(l);return this},__config:function(){return s("Collection","config",this._config[this._key])},__collection:function(){var l=this._collection;return($.exists(l))?l:$.ku4store().read(this.__config().name)}};$.ku4webApp.store=function(v,l,u,w){return new k(v,l,u,w)};function p(l){this._config=s("templates","config",l)}p.prototype={$config:function(l){return($.exists(l))?this._config[l]:this._config},$forms:function(l){return($.exists(l))?this._config.forms[l]:this._config.forms},$views:function(l){return($.exists(l))?this._config.views[l]:this._config.views},$render:function(l,u){return $.str.render(l,u)},$renderList:function(v,u){var l="";$.list(u).each(function(w){l+=this.$render(v,w)},this);return l},$renderListWithAction:function(u,v){var l="";$.list(u).each(function(w){l+=v.call(this,w)},this);return l}};$.ku4webApp.abstractTemplate=p;$.ku4webApp.template=function(l,v){function u(w){u.base.call(this,w)}u.prototype=v;$.Class.extend(u,p);$.ku4webApp.templates[l]=function(w){var x=s($.str.format("templates.{0}",l),"config",w);return new u(x)}};function a(u,l){this._templateFactory=s("views","templateFactory",u);this._formFactory=s("views","formFactory",l)}a.prototype={$template:function(l){return this._templateFactory.create(l)},$form:function(l){return this._formFactory.create(l)}};$.ku4webApp.abstractView=a;$.ku4webApp.__views={};$.ku4webApp.view=function(u,v,w){function l(y,x){l.base.call(this,y,x)}l.prototype=v;$.Class.extend(l,a);$.ku4webApp.views[u]=function(z){var x=$.str.format("$.ku4webApp.views.{0}",u),y=$.str.format("Requires a valid app. app= {0}",z);if(!$.exists(z)){throw $.ku4exception(x,y)}if(!$.exists($.ku4webApp.__views[u])){var A=new l(z.templateFactory,z.formFactory);if($.exists(w)){$.hash(w).each(function(B){z.mediator.subscribe(B.key,A[B.value],A)})}$.ku4webApp.__views[u]=A}return $.ku4webApp.__views[u]}};function e(l){this._config=l}e.prototype={create:function(l){return $.ku4webApp.form(this._config[l])}};$.ku4webApp.formFactory=function(l){return new e(l)};function h(v,l,w,u){var x=$.hash();$.hash($.ku4webApp.models).each(function(y){x.add(y.key,y.value(v,l,w,u))},this);this._models=x}h.prototype={create:function(l){return this._models.find(l)}};$.ku4webApp.modelFactory=function(v,l,w,u){return new h(v,l,w,u)};function b(u,l){this._mediator=u;this._config=l}b.prototype={create:function(l){return $.ku4webApp.service(this._mediator,this._config[l])}};$.ku4webApp.serviceFactory=function(u,l){return new b(u,l)};function r(u,l){this._mediator=u;this._config=l}r.prototype={create:function(l){return $.ku4webApp.store(this._mediator,this._config,l)}};$.ku4webApp.storeFactory=function(u,l){return new r(u,l)};function n(l){this._config=l}n.prototype={create:function(l){return $.ku4webApp.templates[l](this._config)}};$.ku4webApp.templateFactory=function(l){return new n(l)};function f(l){this._config=l}f.prototype={create:function(l){return $.ku4webApp.validator(this._config[l])}};$.ku4webApp.validatorFactory=function(l){return new f(l)}})();