(function(r){$.ku4webApp={config:{templates:{}},templates:{},models:{},controllers:{},views:{}};function e(l){e.base.call(this);$.list(l).each(this._add,this)}e.prototype={_add:function(l){var v=$[l.type](l.selector);if($.exists(l.spec)){v.spec(l.spec)}if(l.required&&$.exists(v.required)){v.required()}if($.isNullOrEmpty(v.dom().name)){throw $.ku4exception("form","Form requires all field DOM elements have a valid 'name' attribute")}else{this.add(v.dom().name,v)}}};$.Class.extend(e,$.form.Class);$.ku4webApp.form=function(l){return new e(l)};function h(l){this._container=$(l);this._display="css-responsebox-show"}h.prototype={show:function(l){this._container.html(l).addClass(this._display)},hide:function(){this._container.html("").removeClass(this._display)}};$.ku4webApp.responsebox=function(l){return new h(l)};function k(l){this._config=l}k.prototype={validate:function(w){var l=this._config,y=true,v=$.hash({}),x=w||$.dto();$.list(l).each(function(C){var A=C.name,z=C.spec,B=C.message,D=x.find(A);if(z.isSatisfiedBy(D)){return}y=false;v.add(A,B)});return{isValid:y,messages:v.toObject()}}};$.ku4webApp.validator=function(l){return new k(l)};function n(){var y=$.ku4webApp,w=$.mediator(),l=y.serviceFactory(w,y.config.services),x=y.storeFactory(w,y.config.collections),v=y.validatorFactory(y.config.validators);this.modelFactory=y.modelFactory(w,l,x,v);this.templateFactory=y.templateFactory(y.config.templates);this.formFactory=y.formFactory(y.config.forms);this.mediator=w}n.prototype={logErrors:function(){this.mediator.logErrors();return this},throwErrors:function(){this.mediator.throwErrors();return this}};$.ku4webApp.app=function(){return new n()};function t(w,l,y){var x=$.str.format("$.ku4webApp.{0}",w),v=$.str.format("Requires a valid {0}. {0}= {1}",l,y);if(!$.exists(y)){throw $.ku4exception(x,v)}else{return y}}function d(v,l){this._modelFactory=t("controllers","modelFactory",v);this._formFactory=t("controllers","formFactory",l)}d.prototype={$model:function(l){return this._modelFactory.create(l)},$form:function(l){return this._formFactory.create(l)}};$.ku4webApp.abstractController=d;$.ku4webApp.controller=function(v,w){function l(z,x,y){l.base.call(this,z,x,y)}l.prototype=w;$.Class.extend(l,d);$.ku4webApp.controllers[v]=function(z){var x=$.str.format("$.ku4webApp.controllers.{0}",v),y=$.str.format("Requires a valid app. app= {0}",z);if(!$.exists(z)){throw $.ku4exception(x,y)}return new l(z.modelFactory,z.formFactory,z.validatorFactory)}};function p(w,l,x,v){this._mediator=t("models","mediator",w);this._serviceFactory=t("models","serviceFactory",l);this._storeFactory=t("models","storeFactory",x);this._validatorFactory=t("models","validatorFactory",v);this._state=new j()}p.prototype={$collection:function(l){return this._storeFactory.create(l)},$service:function(l){return this._serviceFactory.create(l)},$validator:function(l){return this._validatorFactory.create(l)},$state:function(l){if(!$.exists(l)){return this._state}this._state=new j(l);return this},$appState:function(l){if(!$.exists(l)){return a}a=new j(l);return this},$notify:function(){var l=this._mediator;l.notify.apply(l,arguments);return this}};$.ku4webApp.abstractModel=p;$.ku4webApp.model=function(v,w,x){function l(A,y,B,z){l.base.call(this,A,y,B,z)}l.prototype=w;$.Class.extend(l,p);$.ku4webApp.models[v]=function(A,y,B,z){var C=new l(A,y,B,z);if($.exists(x)){$.hash(x).each(function(E){var D=E.key;A.unsubscribe(D,v).subscribe(D,C[E.value],C,v)})}return C}};function u(v,l){this._mediator=v;this._config=l;this._noCache=false}u.prototype={noCache:function(){this._noCache=true;return this},call:function(x){var v=this._config,w=this._mediator,l=$.service()[v.verb]().uri(v.uri);l.contentType(v.contentType);if(this._noCache){l.noCache()}l.onSuccess(function(y){if($.exists(v.success)){w.notify(y,l.processId(),v.success)}},this).onError(function(y){if($.exists(v.error)){w.notify(y,l.processId(),v.error)}},this).call(x);return l}};$.ku4webApp.service=function(v,l){return new u(v,l)};function j(l){this._value=l}j.prototype={is:function(l){return this._value===l},checkAndSet:function(l){var v=this.is(l);this._value=l;return v}};var a=new j("__ku4appStarted__");function m(w,l,v,x){this._mediator=w;this._config=l;this._key=v;this._collection=x}m.prototype={init:function(l){this._collection=null;this.__collection().init(l).save();return this},find:function(w){var l=this.__config(),v=this.__collection().find(w);if($.exists(l.find)){this._mediator.notify(v,l.find)}return v},insert:function(w){var l=this.__config(),v=$.str.format('Cannot insert invalid type: {1} into Collection["{0}"]',l.name,w),x=this.__collection();if(!$.exists(w)){throw $.ku4exception("Collection",v)}x.insert(w).save();if($.exists(l.insert)){this._mediator.notify(x,l.insert)}return this},insertList:function(l){this.__collection().insertList(l).save();return this},update:function(z,w){var v=this.__config(),l=$.str.format('Cannot update type: {1} into Collection["{0}"]',v.name,w);if(!$.exists(w)){throw $.ku4exception("Collection",l)}var x=($.exists(w.toObject))?w.toObject():w;var y=this.__collection().update(z,x).save();if($.exists(v.update)){this._mediator.notify(y,v.update)}return this},remove:function(v){var w=($.exists(v)&&$.exists(v.toObject))?v.toObject():v,l=this.__config(),x=this.__collection().remove(w).save();if($.exists(l.remove)){this._mediator.notify(x,l.remove)}return this},join:function(){var x=this._config,l=arguments[0],D=arguments[1],w=arguments[2],F=arguments[3],E=x[l],z=($.exists(E))?E.name:l,B=this.__collection(),y=$.ku4store().read(z),v=B.join(y,D,w,F),C=v.name(),A=$.hash(x).replicate().add(C,{name:C}).toObject();return new m(this._mediator,A,C,v)},exec:function(l){this._collection=this.__collection().exec(l);return this},__config:function(){return t("Collection","config",this._config[this._key])},__collection:function(){var l=this._collection;return($.exists(l))?l:$.ku4store().read(this.__config().name)}};$.ku4webApp.store=function(w,l,v,x){return new m(w,l,v,x)};function q(l){this._config=t("templates","config",l)}q.prototype={$config:function(l){return($.exists(l))?this._config[l]:this._config},$forms:function(l){return($.exists(l))?this._config.forms[l]:this._config.forms},$views:function(l){return($.exists(l))?this._config.views[l]:this._config.views},$render:function(l,v){return $.str.render(l,v)},$renderList:function(w,v){var l="";$.list(v).each(function(x){l+=this.$render(w,x)},this);return l},$renderListWithAction:function(v,w){var l="";$.list(v).each(function(x){l+=w.call(this,x)},this);return l}};$.ku4webApp.abstractTemplate=q;$.ku4webApp.template=function(l,w){function v(x){v.base.call(this,x)}v.prototype=w;$.Class.extend(v,q);$.ku4webApp.templates[l]=function(x){var y=t($.str.format("templates.{0}",l),"config",x);return new v(y)}};function b(v,l){this._templateFactory=t("views","templateFactory",v);this._formFactory=t("views","formFactory",l)}b.prototype={$template:function(l){return this._templateFactory.create(l)},$form:function(l){return this._formFactory.create(l)}};$.ku4webApp.abstractView=b;$.ku4webApp.__views={};$.ku4webApp.view=function(v,w,x){function l(z,y){l.base.call(this,z,y)}l.prototype=w;$.Class.extend(l,b);$.ku4webApp.views[v]=function(A){var y=$.str.format("$.ku4webApp.views.{0}",v),z=$.str.format("Requires a valid app. app= {0}",A);if(!$.exists(A)){throw $.ku4exception(y,z)}if(!$.exists($.ku4webApp.__views[v])){var B=new l(A.templateFactory,A.formFactory);if($.exists(x)){$.hash(x).each(function(C){A.mediator.subscribe(C.key,B[C.value],B)})}$.ku4webApp.__views[v]=B}return $.ku4webApp.__views[v]}};function f(l){this._config=l}f.prototype={create:function(l){return $.ku4webApp.form(this._config[l])}};$.ku4webApp.formFactory=function(l){return new f(l)};function i(w,l,x,v){var y=$.hash();$.hash($.ku4webApp.models).each(function(z){y.add(z.key,z.value(w,l,x,v))},this);this._models=y}i.prototype={create:function(l){return this._models.find(l)}};$.ku4webApp.modelFactory=function(w,l,x,v){return new i(w,l,x,v)};function c(v,l){this._mediator=v;this._config=l}c.prototype={create:function(l){return $.ku4webApp.service(this._mediator,this._config[l])}};$.ku4webApp.serviceFactory=function(v,l){return new c(v,l)};function s(v,l){this._mediator=v;this._config=l}s.prototype={create:function(l){return $.ku4webApp.store(this._mediator,this._config,l)}};$.ku4webApp.storeFactory=function(v,l){return new s(v,l)};function o(l){this._config=l}o.prototype={create:function(l){return $.ku4webApp.templates[l](this._config)}};$.ku4webApp.templateFactory=function(l){return new o(l)};function g(l){this._config=l}g.prototype={create:function(l){return $.ku4webApp.validator(this._config[l])}};$.ku4webApp.validatorFactory=function(l){return new g(l)}})();