(function(s){$.ku4webApp={config:{templates:{}},templates:{},models:{},controllers:{},views:{}};function e(l){e.base.call(this);$.list(l).each(this._add,this)}e.prototype={_add:function(l){var w=$[l.type](l.selector);if($.exists(l.spec)){w.spec(l.spec)}if($.exists(l.maxDims)){w.maxDims(l.maxDims)}if(l.required&&$.exists(w.required)){w.required()}if($.isNullOrEmpty(w.dom().name)){throw $.ku4exception("form","Form requires all field DOM elements have a valid 'name' attribute")}else{this.add(w.dom().name,w)}}};$.Class.extend(e,$.form.Class);$.ku4webApp.form=function(l){return new e(l)};function i(l){this._container=$(l);this._display="css-responsebox-show"}i.prototype={show:function(l){this._container.html(l).addClass(this._display)},hide:function(){this._container.html("").removeClass(this._display)}};$.ku4webApp.responsebox=function(l){return new i(l)};function m(l){this._config=l}m.prototype={validate:function(x){var l=this._config,z=true,w=$.hash({}),y=x||$.dto();$.list(l).each(function(D){var B=D.name,A=D.spec,C=D.message,E=y.find(B);if(A.isSatisfiedBy(E)){return}z=false;w.add(B,C)});return{isValid:z,messages:w.toObject()}}};$.ku4webApp.validator=function(l){return new m(l)};function d(x,w,l){this._modelFactory=u("controllers","modelFactory",x);this._formFactory=u("controllers","formFactory",w);this._navigator=l}d.prototype={$model:function(l){return this._modelFactory.create(l)},$form:function(l){return this._formFactory.create(l)},$navigator:function(){return this._navigator}};$.ku4webApp.abstractController=d;$.ku4webApp.controller=function(w,x){function l(A,z,y){l.base.call(this,A,z,y)}l.prototype=x;$.Class.extend(l,d);$.ku4webApp.controllers[w]=function(A){var y=$.str.format("$.ku4webApp.controllers.{0}",w),z=$.str.format("Requires a valid app. app= {0}",A);if(!$.exists(A)){throw $.ku4exception(y,z)}return new l(A.modelFactory,A.formFactory,A.navigator)}};function q(x,l,y,w){this._mediator=u("models","mediator",x);this._serviceFactory=u("models","serviceFactory",l);this._storeFactory=u("models","storeFactory",y);this._validatorFactory=u("models","validatorFactory",w);this._state=new k()}q.prototype={$collection:function(l){return this._storeFactory.create(l)},$service:function(l){return this._serviceFactory.create(l)},$validator:function(l){return this._validatorFactory.create(l)},$state:function(){return this._state},$appState:function(l){if(!$.exists(l)){return a}a=new k(l);return this},$notify:function(){var l=this._mediator;l.notify.apply(l,arguments);return this}};$.ku4webApp.abstractModel=q;$.ku4webApp.model=function(w,x,y){function l(B,z,C,A){l.base.call(this,B,z,C,A)}l.prototype=x;$.Class.extend(l,q);$.ku4webApp.models[w]=function(B,z,C,A){var D=new l(B,z,C,A);if($.exists(y)){$.hash(y).each(function(H){var E=H.key,F=H.value,J=$.str.format("ku4webApp.model.{0}_{1}",w,F),I=D[F];try{B.unsubscribe(E,J).subscribe(E,I,D,J)}catch(G){throw $.ku4exception("$.ku4webApp.model",$.str.format("$.ku4webApp.model.{0} cannot subscribe to mediator with name: {1} or method: {2}.\n\nmessage:{3}\n\n",w,E,F,G.message))}})}return D}};function v(y,x,w){this._mediator=y;this._config=w;var l=$.service(x)[w.verb]().uri(w.uri);l.contentType(w.contentType);if($.exists(w.success)){l.onSuccess(function(z){y.notify(z,l.processId(),w.success)},this,w.success)}if($.exists(w.error)){l.onError(function(z){y.notify(z,l.processId(),w.error)},this,w.success)}if($.exists(w.complete)){l.onError(function(z){y.notify(z,l.processId(),w.complete)},this,w.complete)}this._service=l}v.prototype={cache:function(){this._service.cache();return this},noCache:function(){this._service.noCache();return this},lock:function(){this._service.lock();return this},unlock:function(){this._service.unlock();return this},abort:function(){this._service.abort();return this},call:function(l){this._service.call(l);return this}};$.ku4webApp.service=function(x,w,l){return new v(x,w,l)};function k(l){this._value=l;this._data=$.hash()}k.prototype={is:function(l){return this._value===l},set:function(l){this._value=l;return this},read:function(l){return this._data.findValue(l)},write:function(l,w){this._data.update(l,w);return this}};var a=new k("__ku4appStarted__");function n(x,l,w,y){this._mediator=x;this._config=l;this._key=w;this._collection=y}n.prototype={init:function(l){this._collection=null;this.__collection().init(l).save();return this},find:function(x){var l=this.__config(),w=this.__collection().find(x);if($.exists(l.find)){this._mediator.notify(w,l.find)}return w},insert:function(x){var l=this.__config(),w=$.str.format('Cannot insert invalid type: {1} into Collection["{0}"]',l.name,x),y=this.__collection();if(!$.exists(x)){throw $.ku4exception("Collection",w)}y.insert(x).save();if($.exists(l.insert)){this._mediator.notify(y,l.insert)}return this},insertList:function(l){this.__collection().insertList(l).save();return this},update:function(A,x){var w=this.__config(),l=$.str.format('Cannot update type: {1} into Collection["{0}"]',w.name,x);if(!$.exists(x)){throw $.ku4exception("Collection",l)}var y=($.exists(x.toObject))?x.toObject():x;var z=this.__collection().update(A,y).save();if($.exists(w.update)){this._mediator.notify(z,w.update)}return this},remove:function(w){var x=($.exists(w)&&$.exists(w.toObject))?w.toObject():w,l=this.__config(),y=this.__collection().remove(x).save();if($.exists(l.remove)){this._mediator.notify(y,l.remove)}return this},join:function(){var y=this._config,l=arguments[0],E=arguments[1],x=arguments[2],G=arguments[3],F=y[l],A=($.exists(F))?F.name:l,C=this.__collection(),z=$.ku4store().read(A),w=C.join(z,E,x,G),D=w.name(),B=$.hash(y).replicate().add(D,{name:D}).toObject();return new n(this._mediator,B,D,w)},exec:function(l){this._collection=this.__collection().exec(l);return this},__config:function(){return u("Collection","config",this._config[this._key])},__collection:function(){var l=this._collection;return($.exists(l))?l:$.ku4store().read(this.__config().name)}};$.ku4webApp.store=function(x,l,w,y){return new n(x,l,w,y)};function f(y,w){this._modelFactory=y;this._config=w;this._notify=true;var x=this;function l(){if(x._notify){x.execute(x.read())}x._notify=true}if($.exists(window.addEventListener)){window.addEventListener("hashchange",l)}else{if($.exists(window.attachEvent)){window.attachEvent("onhashchange",l)}}}f.prototype={hashEquals:function(l){return this.read()==l},hash:function(l){return($.exists(l))?this.write(l,true):this.read()},read:function(){return location.hash.substr(1)},write:function(x,w){var l=this.read();this._notify=(w)?false:true;location.hash=x;return this},forward:function(){window.history.forward();return this},back:function(){window.history.back();return this},execute:function(z){var y=this._config;if(!$.exists(y)){return}var C=y[z];if(!$.exists(C)){return}var l=C.model,w=C.method,B=this._modelFactory;if($.exists(l)&&$.exists(w)){try{var x=B.create(l);x[w]()}catch(A){}}return this},executeOrDefault:function(x,w){var l=this._config;if(!$.exists(l)){return}var y=l[x];return($.exists(y))?this.execute(y):this.execute(l[w])}};$.ku4webApp.navigator=function(w,l){return new f(w,l)};function r(l){this._config=u("templates","config",l)}r.prototype={$config:function(l){return($.exists(l))?this._config[l]:this._config},$forms:function(l){return($.exists(l))?this._config.forms[l]:this._config.forms},$views:function(l){return($.exists(l))?this._config.views[l]:this._config.views},$render:function(l,w){return $.str.render(l,w)},$renderList:function(x,w){var l="";$.list(w).each(function(y){l+=this.$render(x,y)},this);return l},$renderListWithAction:function(w,x){var l="";$.list(w).each(function(y){l+=x.call(this,y)},this);return l}};$.ku4webApp.abstractTemplate=r;$.ku4webApp.template=function(l,x){function w(y){w.base.call(this,y)}w.prototype=x;$.Class.extend(w,r);$.ku4webApp.templates[l]=function(y){var z=u($.str.format("templates.{0}",l),"config",y);return new w(z)}};function b(x,w,l){this._templateFactory=u("views","templateFactory",x);this._formFactory=u("views","formFactory",w);this._navigator=u("views","navigator",l);this._state=new k()}b.prototype={$template:function(l){return this._templateFactory.create(l)},$form:function(l){return this._formFactory.create(l)},$navigator:function(){return this._navigator},$state:function(){return this._state}};$.ku4webApp.abstractView=b;$.ku4webApp.__views={};$.ku4webApp.view=function(w,x,y){function l(B,A,z){l.base.call(this,B,A,z)}l.prototype=x;$.Class.extend(l,b);$.ku4webApp.views[w]=function(B){var z=$.str.format("$.ku4webApp.views.{0}",w),A=$.str.format("Requires a valid app. app= {0}",B);if(!$.exists(B)){throw $.ku4exception(z,A)}if(!$.exists($.ku4webApp.__views[w])){var C=new l(B.templateFactory,B.formFactory,B.navigator);if($.exists(y)){$.hash(y).each(function(G){var D=G.key,E=G.value,I=$.str.format("ku4webApp.view_{0}_{1}",w,E),H=C[E];try{B.mediator.unsubscribe(D,I).subscribe(D,H,C,I)}catch(F){throw $.ku4exception("$.ku4webApp.view",$.str.format("$.ku4webApp.view.{0} cannot subscribe to mediator with name: {1} or key: {2}.\n\nmessage:{3}\n\n",w,D,E,F.message))}})}$.ku4webApp.__views[w]=C}return $.ku4webApp.__views[w]}};function g(l){this._config=l}g.prototype={create:function(l){return $.ku4webApp.form(this._config[l])}};$.ku4webApp.formFactory=function(l){return new g(l)};function j(x,l,y,w){var z=$.hash();$.hash($.ku4webApp.models).each(function(A){z.add(A.key,A.value(x,l,y,w))},this);this._models=z}j.prototype={create:function(l){return this._models.find(l)}};$.ku4webApp.modelFactory=function(x,l,y,w){return new j(x,l,y,w)};function c(x,l){var w=$.hash();$.hash(l).each(function(y){w.add(y.key,$.ku4webApp.service(x,y.key,y.value))},this);this._services=w}c.prototype={create:function(l){return this._services.find(l)}};$.ku4webApp.serviceFactory=function(w,l){return new c(w,l)};function t(w,l){this._mediator=w;this._config=l}t.prototype={create:function(l){return $.ku4webApp.store(this._mediator,this._config,l)}};$.ku4webApp.storeFactory=function(w,l){return new t(w,l)};function p(l){this._config=l}p.prototype={create:function(l){return $.ku4webApp.templates[l](this._config)}};$.ku4webApp.templateFactory=function(l){return new p(l)};function h(l){this._config=l}h.prototype={create:function(l){return $.ku4webApp.validator(this._config[l])}};$.ku4webApp.validatorFactory=function(l){return new h(l)};function o(w){var l=w||$.uid(),B=$.ku4webApp,z=$.mediator("ku4webApp_"+l),x=B.serviceFactory(z,B.config.services),A=B.storeFactory(z,B.config.collections),y=B.validatorFactory(B.config.validators);this.modelFactory=B.modelFactory(z,x,A,y);this.templateFactory=B.templateFactory(B.config.templates);this.formFactory=B.formFactory(B.config.forms);this.navigator=B.navigator(this.modelFactory,B.config.navigator);this.mediator=z}o.prototype={logErrors:function(){this.mediator.logErrors();return this},throwErrors:function(){this.mediator.throwErrors();return this}};$.ku4webApp.app=function(l){return new o(l)};function u(x,l,z){var y=$.str.format("$.ku4webApp.{0}",x),w=$.str.format("Requires a valid {0}. {0}= {1}",l,z);if(!$.exists(z)){throw $.ku4exception(y,w)}else{return z}}})();